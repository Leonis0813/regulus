<%= javascript_tag do %>
$('#rate').html('<svg width="100%" height="620px" id="graph"></svg>');

var dataSet = <%= @rates.map {|rate| rate[1..-1] } %>
var min = <%= @rates.map {|rate| rate[3] }.sort.first %>
var max = <%= @rates.map {|rate| rate[2] }.sort.last %>

var xScale = d3.time.scale()
  .domain([
    new Date('<%= (Time.parse(@rates.last[0]) + 9 * 60 * 60).strftime('%Y-%m-%d %H:%M:%S') %>'),
    new Date('<%= (Time.parse(@rates.first[0]) + 9 * 60 * 60).strftime('%Y-%m-%d %H:%M:%S') %>')
  ])
  .range([40, 1228]);

var yScale = d3.scale.linear()
  .domain([min, max])
  .range([500, 0]);

var line = d3.svg.line()
  .x(function(d) {return 1400 - (d[0] * 12 + 100) + 3;})
  .y(function(d) {return 50 + (500 * (max-d[1]))/(max-min);});

d3.select("#graph")
  .append("g")
  .attr("class", "axis")
  .attr("transform", "translate(75, 580)")
  .call(
    d3.svg.axis()
      .scale(xScale)
      .orient("bottom")
      .innerTickSize(-530)
      .outerTickSize(2)
      .tickPadding(10)
      .ticks(15)
      .tickFormat(d3.time.format('%H:%M'))
  )

d3.select("#graph")
  .append("g")
  .attr("class", "axis")
  .attr("transform", "translate(75, 50)")
  .call(
    d3.svg.axis()
      .scale(yScale)
      .orient("left")
      .innerTickSize(-1228)
      .outerTickSize(0)
      .tickPadding(10)
  )

d3.select("#graph")
  .selectAll("path")
  .data(dataSet)
  .enter()
  .append("path")
  .attr("d", function(d, i){
    return line([[i, d[1]], [i, d[2]]]);
  })
  .attr("stroke", "black")
										
d3.select("#graph")
  .selectAll("rect")
  .data(dataSet)
  .enter()
  .append("rect")
  .attr("x", function(d, i){
    return 1400 - (i * 12 + 100);
  })
  .attr("y", function(d, i){
    if(d[3] > d[0])
      return 50 + (500 * (max-d[3]))/(max-min);
    else
      return 50 + (500 * (max-d[0]))/(max-min);
  })
  .attr("width", "6px")
  .attr("height", function(d, i){
    if(d[3] == d[0])
      return "1px";
    else
      return (500 * Math.abs(d[3] - d[0]))/(max-min) + "px";
  })
  .style("fill", function(d, i){
    if(d[3] > d[0])
      return "red";
    else if(d[3] < d[0])
      return "blue";
    else
      return "black";
  })
  .on("mouseover", function(){
    d3.select("#graph")
      .append("rect")
      .attr("class", "info")
      .attr("x", d3.mouse(this)[0] + 10)
      .attr("y", d3.mouse(this)[1] - 100)
      .attr("width", "100px")
      .attr("height", "100px")
      .attr("stroke", "black")
      .attr("fill", "white")
  })
  .on("mouseout", function(){
    d3.select(".info")
      .remove()
  })
<% end %>
